{% extends 'home/base.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex align-items-center mb-4">
        <a href="{% url 'mapa_sluzeb' %}" class="text-decoration-none me-3" style="color: #8B4513; transition: 0.3s;" title="Zpƒõt na mapu">
            <span style="font-size: 2rem;">‚Üê</span>
        </a>
        <h2 class="mb-0" style="color: #8B4513; font-weight: bold;">üìç P≈ôidat novou slu≈æbu</h2>
    </div>

    <div class="row">
        <div class="col-md-5">
            <div class="card p-4 shadow-sm" style="border-radius: 20px; border: none;">
                <button type="button" class="btn btn-outline-primary mb-3 fw-bold" onclick="najdiMne()" style="border-color: #8B4513; color: #8B4513;">
                    üìç Zamƒõ≈ôit moji polohu (GPS)
                </button>

                <form method="post">
                    {% csrf_token %}
                    {{ form.as_p }}

                    <div class="d-flex gap-2 mt-3">
                        <button type="submit" class="btn fw-bold flex-grow-1" style="background-color: #8B4513; color: white; border-radius: 10px; padding: 10px;">
                            Odeslat z√°znam
                        </button>
                        <a href="{% url 'mapa_sluzeb' %}" class="btn btn-outline-secondary d-flex align-items-center" style="border-radius: 10px; padding: 0 20px;">
                            Zru≈°it
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card shadow-sm p-0" style="border-radius: 20px; overflow: hidden; border: none;">
                <div id="map-picker" style="height: 600px; width: 100%; background-color: #f8f9fa;"></div>
            </div>
            <p class="text-muted mt-2 small text-center">üí° Kliknƒõte do mapy pro automatick√© vyplnƒõn√≠ sou≈ôadnic nebo pou≈æijte tlaƒç√≠tko GPS.</p>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    var mapPicker;
    var marker;

    function setCoords(lat, lon) {
        var latField = document.getElementById('id_lat');
        var lonField = document.getElementById('id_lon');

        if (latField && lonField) {
            latField.value = lat.toFixed(6);
            lonField.value = lon.toFixed(6);
        }

        if (marker) {
            marker.setLatLng([lat, lon]);
        } else {
            marker = L.marker([lat, lon], {draggable: true}).addTo(mapPicker);
            marker.on('dragend', function(e) {
                var pos = marker.getLatLng();
                setCoords(pos.lat, pos.lng);
            });
        }
    }

    function najdiMne() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var lat = position.coords.latitude;
                var lon = position.coords.longitude;
                mapPicker.setView([lat, lon], 16);
                setCoords(lat, lon);
            }, function() {
                alert("Nepoda≈ôilo se z√≠skat polohu. Povolte pros√≠m GPS.");
            });
        } else {
            alert("V√°≈° prohl√≠≈æeƒç nepodporuje geolokaci.");
        }
    }

    function geokodujAdresu() {
        var adresaField = document.getElementById('id_adresa');
        if (!adresaField) return;

        var adresa = adresaField.value;
        if (adresa.length > 5) {
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(adresa)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        var lat = parseFloat(data[0].lat);
                        var lon = parseFloat(data[0].lon);
                        mapPicker.setView([lat, lon], 16);
                        setCoords(lat, lon);
                    }
                })
                .catch(err => console.error("Chyba p≈ôi geok√≥dov√°n√≠:", err));
        }
    }

    // V≈°echnu inicializaci d√°me do jednoho bloku
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Inicializace mapy
        mapPicker = L.map('map-picker').setView([49.8, 15.5], 7);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(mapPicker);

        // 2. Kliknut√≠ do mapy
        mapPicker.on('click', function(e) {
            setCoords(e.latlng.lat, e.latlng.lng);
        });

        // 3. Hl√≠d√°n√≠ adresy pro automatick√© GPS
        var adresaInput = document.getElementById('id_adresa');
        if (adresaInput) {
            adresaInput.addEventListener('blur', geokodujAdresu);
        }

        // 4. Oprava velikosti mapy
        setTimeout(function() {
            mapPicker.invalidateSize();
        }, 300);
    });
</script>
{% endblock %}