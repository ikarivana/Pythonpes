{% extends 'home/base.html' %}

{% block content %}
<style>
    #map {
        height: 600px !important;
        width: 100%;
        border-bottom: 5px solid var(--light-tan);
        background-color: #e5e3df;
        z-index: 1;
        display: block;
    }

    @media (max-width: 768px) {
        #map { height: 70vh !important; }
    }

    .leaflet-popup-content-wrapper { border-radius: 12px; padding: 5px; }

    .btn-call {
        background-color: #8B4513; /* primary-brown */
        color: white !important;
        display: block;
        text-align: center;
        padding: 5px;
        border-radius: 5px;
        text-decoration: none;
        margin-top: 10px;
        font-weight: bold;
    }

    .badge {
        padding: 8px 12px;
        border-radius: 50px;
        font-size: 0.8rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        color: white;
    }
</style>

<div class="p-4 bg-white">
    <h2 style="color: #8B4513; font-weight: bold;" class="mb-4">üìç Interaktivn√≠ mapa slu≈æeb</h2>

    <div class="d-flex justify-content-between align-items-center w-100 mb-3" style="gap: 20px;">

        <div class="d-flex flex-wrap gap-2">
            <button class="badge border-0" style="background-color: #8B4513; cursor: pointer;" onclick="filtrujMapu('vse')">V≈°e</button>
            <button class="badge border-0" style="background-color: red; cursor: pointer;" onclick="filtrujMapu('veterina')">Veterina</button>
            <button class="badge border-0" style="background-color: blue; cursor: pointer;" onclick="filtrujMapu('obchod')">Obchody</button>
            <button class="badge border-0" style="background-color: orange; cursor: pointer;" onclick="filtrujMapu('hotel')">Hotely</button>
            <button class="badge border-0" style="background-color: green; cursor: pointer;" onclick="filtrujMapu('wellness')">Wellness</button>
            <button class="badge border-0" style="background-color: purple; cursor: pointer;" onclick="filtrujMapu('cvicak')">Cviƒç√°ky</button>
            <button class="badge border-0" style="background-color: darkred; cursor: pointer;" onclick="filtrujMapu('utulek')">√ötulky</button>
            <button class="badge border-0" style="background-color: #ff69b4; cursor: pointer;" onclick="filtrujMapu('chovna_stanice')">Chovn√© stanice</button>
        </div>

        <div class="text-end" style="min-width: 220px;">
            <a href="{% url 'pridat_sluzbu' %}" class="btn fw-bold text-white shadow-sm"
               style="background-color: #28a745; border-radius: 10px; padding: 10px 20px; white-space: nowrap;">
                ‚ûï Navrhnout novou slu≈æbu
            </a>
        </div>
    </div>

    <div class="card shadow-sm p-0" style="border-radius: 20px; overflow: hidden; border: none;">
        <div id="map"></div>
    </div>
</div>

<div class="card shadow-sm p-0" style="border-radius: 20px; overflow: hidden; border: none;">
    <div id="map"></div>
</div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    var allMarkers = []; // Sem si ulo≈æ√≠me v≈°echny ≈°pendl√≠ky
    var map; // Promƒõnn√° pro mapu

    // Tato funkce zajist√≠, ≈æe se zobraz√≠ jen to, co chceme
    function filtrujMapu(kategorie) {
        allMarkers.forEach(function(item) {
            if (kategorie === 'vse' || item.typ === kategorie) {
                item.marker.addTo(map);
            } else {
                map.removeLayer(item.marker);
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Vytvo≈ôen√≠ mapy
        map = L.map('map', { center: [49.8, 15.5], zoom: 7 });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        // Tato funkce teƒè dostane jen barvy, kter√© GitHub um√≠
        function createIcon(color) {
            return new L.Icon({
                iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
        }

        var sluzby = {{ sluzby_json|safe }};
        var currentUserId = {{ request.user.id|default:"null" }};

        sluzby.forEach(function(s) {
            if (s.lat && s.lon) {
                // OPRAVEN√â MAPOV√ÅN√ç BAREV:
                // GitHub zn√°: blue, gold, red, green, orange, yellow, violet, grey, black
                const barvy = {
                    'veterina': 'red',
                    'obchod': 'blue',
                    'hotel': 'orange',
                    'wellness': 'green',
                    'cvicak': 'violet',       // opraveno z purple
                    'utulek': 'black',        // opraveno z darkred
                    'chovna_stanice': 'gold'   // opraveno z pink
                };

                // Pokud barvu nenajde, d√°me 'blue' (standardn√≠ ≈°pendl√≠k)
                var colorName = barvy[s.typ_slug] || 'blue';

                var marker = L.marker([s.lat, s.lon], {icon: createIcon(colorName)}).addTo(map);

                // Ulo≈æ√≠me marker pro pozdƒõj≈°√≠ filtrov√°n√≠
                allMarkers.push({ marker: marker, typ: s.typ_slug });

                // Popup obsah s tv√Ωm stylem
                var popupContent = `
                    <div style="min-width: 150px;">
                        <strong style="color: #8B4513;">${s.nazev}</strong><br>
                        <small>${s.typ}</small><br>
                        <hr style="margin: 5px 0;">
                        ${s.adresa}
                    </div>
                `;
                marker.bindPopup(popupContent);
            }
        });

        // Oprava ≈°ed√© plochy
        setTimeout(function() { map.invalidateSize(); }, 400);
    });
</script>
{% endblock %}