{% extends 'home/base.html' %}

{% block content %}
<style>
    /* Zaji≈°tƒõn√≠, ≈æe mapa m√° v≈ædy pevnou v√Ω≈°ku a je vidƒõt */
    #map {
        height: 600px !important;
        width: 100%;
        border-bottom: 5px solid var(--light-tan);
        background-color: #e5e3df; /* Tradiƒçn√≠ barva pr√°zdn√© mapy */
        z-index: 1;
        display: block;
    }

    @media (max-width: 768px) {
        #map { height: 70vh !important; }
    }

    /* Oprava pro zobrazen√≠ dla≈ædic Leafletu */
    .leaflet-container {
        outline: 0;
    }

    .leaflet-popup-content-wrapper {
        border-radius: 12px;
        padding: 5px;
    }

    .btn-call {
        background-color: var(--primary-brown);
        color: white !important;
        display: block;
        text-align: center;
        padding: 5px;
        border-radius: 5px;
        text-decoration: none;
        margin-top: 10px;
        font-weight: bold;
    }

    .badge {
        padding: 8px 12px;
        border-radius: 50px;
        font-size: 0.8rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
</style>

<div class="p-4 bg-white">
    <h2 style="color: var(--primary-brown); font-weight: bold;">üìç Interaktivn√≠ mapa slu≈æeb</h2>

    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-3">
        <div class="d-flex flex-wrap gap-2">
            <span class="badge" style="background-color: red;">Veterina</span>
            <span class="badge" style="background-color: blue;">Obchody</span>
            <span class="badge" style="background-color: orange;">Hotely</span>
            <span class="badge" style="background-color: green;">Wellness</span>
            <span class="badge" style="background-color: purple;">Cviƒç√°ky</span>
            <span class="badge" style="background-color: darkred;">√ötulky</span>
        </div>

        <a href="{% url 'pridat_sluzbu' %}" class="btn fw-bold text-white shadow-sm"
           style="background-color: #28a745; border-radius: 10px; padding: 10px 20px;">
            ‚ûï Navrhnout novou slu≈æbu
        </a>
    </div>

    <div class="card shadow-sm p-0" style="border-radius: 20px; overflow: hidden; border: none;">
        <div id="map"></div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // Inicializace mapy a≈æ po naƒçten√≠ dokumentu
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Inicializace mapy
        var map = L.map('map', {
            center: [49.8, 15.5],
            zoom: 7,
            // Tato volba pom√°h√° u nƒõkter√Ωch prohl√≠≈æeƒç≈Ø s vykreslen√≠m
            tap: false
        });

        // 2. Podklad mapy (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // 3. Funkce pro barvy
        function getMarkerColor(typ) {
            const barvy = {
                'veterina': 'red',
                'obchod': 'blue',
                'hotel': 'orange',
                'wellness': 'green',
                'cvicak': 'purple',
                'utulek': 'darkred'
            };
            return barvy[typ] || 'cadetblue';
        }

        // 4. Funkce pro ikony
        function createIcon(color) {
            return new L.Icon({
                iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
        }

        // 5. Naƒçten√≠ dat (zaji≈°tƒõn√≠ proti chybƒõ, pokud by data nep≈ôi≈°la)
        var sluzby = {{ sluzby_json|safe|default:"[]" }};

        // 6. Vykreslen√≠ ≈°pendl√≠k≈Ø
        sluzby.forEach(function(s) {
            if (s.lat && s.lon) {
                var color = getMarkerColor(s.typ_slug);
                var icon = createIcon(color);

                var marker = L.marker([s.lat, s.lon], {icon: icon}).addTo(map);

                var popupContent = `
                    <div style="min-width: 200px; font-family: sans-serif;">
                        <strong style="font-size: 1.1rem; color: #8B4513;">${s.nazev}</strong><br>
                        <small style="color: #666;">${s.typ}</small><br>
                        <hr style="margin: 8px 0;">
                        <p style="margin: 0; font-size: 0.9rem;"><strong>Adresa:</strong> ${s.adresa}</p>
                        <p style="margin: 5px 0 10px 0; font-size: 0.85rem; font-style: italic;">${s.popis}</p>
                        <div class="d-grid gap-2">
                            ${s.telefon ? `<a href="tel:${s.telefon}" class="btn-call">üìû Zavolat</a>` : ''}
                            <div class="d-flex justify-content-between gap-1" style="margin-top:5px;">
                                <a href="/mapa/upravit/${s.id}/" class="btn btn-sm btn-outline-secondary" style="flex: 1; font-size: 0.75rem;">‚úèÔ∏è Upravit</a>
                                <a href="/mapa/smazat/${s.id}/" class="btn btn-sm btn-outline-danger" style="flex: 1; font-size: 0.75rem;">üóëÔ∏è Smazat</a>
                            </div>
                        </div>
                    </div>
                `;
                marker.bindPopup(popupContent);
            }
        });

        // AGRESIVN√ç OPRAVA B√çL√âHO ƒåTVERCE
        // 1. Okam≈æitƒõ po naƒçten√≠
        map.invalidateSize();

        // 2. Po kr√°tk√© pauze (kdy u≈æ Bootstrap dokreslil kartu)
        setTimeout(function() {
            map.invalidateSize();
        }, 300);

        // 3. P≈ôi jak√©mkoliv p≈ôekreslen√≠ okna
        window.addEventListener('resize', function() {
            map.invalidateSize();
        });
    });
</script>
{% endblock %}